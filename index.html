<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Kartu Digital Anggota</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* CSS ANDA TETAP SAMA - TIDAK ADA PERUBAHAN */
body{
  margin:0;
  background:linear-gradient(180deg,#061b12,#020b07);
  font-family:'Poppins',sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:16px;
  color:#fff;
}

.card{
  width:100%;
  max-width:390px;
  background:linear-gradient(160deg,#0f3d28,#062015);
  border-radius:22px;
  padding:18px;
  box-shadow:0 0 35px rgba(0,255,160,.35);
  border:1px solid rgba(0,255,160,.35);
  animation:fadeIn 0.5s ease-out;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(20px);}
  to{opacity:1; transform:translateY(0);}
}

.header{
  text-align:center;
  border-bottom:1px dashed rgba(255,255,255,.25);
  padding-bottom:14px;
}

.logo-wrap{
  width:86px;
  height:86px;
  margin:0 auto 10px;
  border-radius:50%;
  background:rgba(255,255,255,.12);
  backdrop-filter:blur(12px);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:
    0 0 18px rgba(0,255,160,.6),
    inset 0 0 12px rgba(255,255,255,.25);
  transition:.4s ease;
  animation:float 4s ease-in-out infinite;
}
.logo-wrap:hover{
  transform:scale(1.08);
  box-shadow:0 0 28px rgba(0,255,160,.9);
}
.logo-wrap img{
  width:58px;
  height:58px;
  border-radius:50%;
  object-fit:cover;
}

@keyframes float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

.header h1{
  font-size:16px;
  margin:0;
  font-weight:700;
  color:#7dffb2;
}
.header small{
  font-size:11px;
  opacity:.85;
}

.status{
  margin:12px auto;
  text-align:center;
}
.status span{
  padding:6px 18px;
  border-radius:20px;
  background:#00ff9d33;
  color:#00ff9d;
  font-size:12px;
  font-weight:600;
}
.status-inactive{
  background:#ff3d0033 !important;
  color:#ffa000 !important;
}

.identity{
  text-align:center;
  margin:14px 0;
}
.identity h2{
  margin:4px 0;
  font-size:17px;
}
.identity p{
  margin:0;
  font-size:12px;
  color:#a9ffd1;
}

.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin:16px 0;
}
.stat{
  background:rgba(0,255,160,.15);
  border-radius:14px;
  padding:10px;
  text-align:center;
}
.stat small{
  font-size:10px;
  opacity:.9;
}
.stat b{
  display:block;
  margin-top:6px;
  font-size:13px;
}

.data{
  font-size:12px;
}
.data div{
  display:flex;
  justify-content:space-between;
  padding:7px 0;
  border-bottom:1px dashed rgba(255,255,255,.25);
}
.data span{
  color:#b6ffd1;
}

.actions{
  display:flex;
  gap:12px;
  margin:18px 0 6px;
}
.actions button{
  flex:1;
  border:none;
  padding:10px;
  border-radius:14px;
  background:rgba(0,255,160,.2);
  color:#00ff9d;
  font-weight:600;
  backdrop-filter:blur(10px);
  box-shadow:0 0 14px rgba(0,255,160,.5);
  transition:.3s;
  cursor:pointer;
  font-family:'Poppins',sans-serif;
}
.actions button:hover{
  background:#00ff9d;
  color:#003a24;
  transform:translateY(-2px);
}

.footer{
  margin-top:10px;
  text-align:center;
  font-size:10px;
  opacity:.75;
}

.loading{
  text-align:center;
  padding:30px;
}
.spinner{
  width:40px;
  height:40px;
  border:3px solid rgba(0,255,160,.3);
  border-top:3px solid #00ff9d;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 15px;
}
@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

.last-update{
  font-size:9px;
  text-align:center;
  margin-top:5px;
  opacity:.6;
}

.qr-section{
  text-align:center;
  margin-top:20px;
  padding-top:15px;
  border-top:1px dashed rgba(255,255,255,.2);
}
.qr-code{
  display:inline-block;
  background:white;
  padding:10px;
  border-radius:12px;
  margin:10px 0;
}
.qr-code canvas{
  display:block;
}
.qr-note{
  font-size:10px;
  opacity:.7;
  margin-top:8px;
}

.error-state{
  text-align:center;
  padding:40px 20px;
}
.error-state h3{
  color:#ffa000;
  margin-bottom:10px;
}

/* DEBUG PANEL */
.debug-panel {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0,0,0,0.8);
  color: #00ff9d;
  padding: 10px;
  border-radius: 5px;
  font-size: 12px;
  max-width: 300px;
  z-index: 1000;
  display: none;
}
.debug-toggle {
  position: fixed;
  top: 10px;
  left: 10px;
  background: #00ff9d;
  color: #003a24;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
  z-index: 1001;
  font-weight: bold;
}
</style>

<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>

<body>

<!-- Debug Toggle Button -->
<button class="debug-toggle" onclick="toggleDebug()">üêõ Debug</button>

<!-- Debug Panel -->
<div class="debug-panel" id="debugPanel">
  <h4>Debug Information</h4>
  <div id="debugInfo"></div>
</div>

<!-- Main Card Container -->
<div class="card" id="cardContainer">
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Memuat data anggota...</p>
  </div>
</div>

<script>
// =================== CONFIGURATION ===================
const CONFIG = {
  // URL Web Apps Script Anda - PASTIKAN INI BENAR
  APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyH4EWqEwAMx_I3JN745wwC8Y3G0iT08iTAr0_cwWm5dyd6dkJBwheS-WHr-jmQBKs/exec',
  
  // KOLOM MAPPING YANG BENAR - SESUAI HEADER SPREADSHEET
  COLUMN_MAPPING: {
    foto: 'Foto',
    id: 'ID/NIA',
    posisi: 'Posisi',
    nama: 'Nama_Lengkap',           // DIPERBAIKI: dari 'namaLengkap' ke 'Nama_Lengkap'
    alamat: 'Alamat_Lengkap',       // DIPERBAIKI: dari 'alamatLengkap' ke 'Alamat_Lengkap'
    jenisKelamin: 'Jenis_Kelamin',
    email: 'Email',
    whatsapp: 'WhatsApp',
    nik: 'NIK',
    agama: 'Agama',
    status: 'Status',
    tanggalBergabung: 'Tanggal_Bergabung',
    simpananPokok: 'Simpanan_Pokok',
    simpananWajib: 'Simpanan_Wajib',
    simpananSukarela: 'Simpanan_Sukarela',
    totalSimpanan: 'Total_Simpanan',
    totalPinjaman: 'Total_Pinjaman',
    shuEstimasi: 'SHU_Estimasi',
    lastUpdate: 'LastUpdated'       // DIPERBAIKI: dari 'lastupdated' ke 'LastUpdated'
  },
  
  // DEMO DATA FALLBACK
  DEMO_MEMBER: {
    "Foto": "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhADAiDm28b0fescUKnqADc9uk3Q2oIptWD-hyzBQXb2AMtoPrxb7Q9Ecr9SDV_RhqA9uWO6qTcepfbfuR7KFWuKUmYYPB-6JfiExBCzT-MljhNh1P1TPsabKvh2rAQzEtZUA0lpiIkIuBxHvHVuXl0GdUWEyaABcfpsHnX_kyDLN_pS2gVNzp_kIP6Vss/s1280/1000007204.jpg",
    "ID/NIA": "NIA-001",
    "Posisi": "Anggota",
    "Nama_Lengkap": "Data Demo - ID Tidak Ditemukan",
    "Alamat_Lengkap": "Alamat tidak tersedia",
    "Jenis_Kelamin": "-",
    "Email": "-",
    "WhatsApp": "-",
    "NIK": "-",
    "Agama": "-",
    "Status": "AKTIF",
    "Tanggal_Bergabung": new Date().toISOString().split('T')[0],
    "Simpanan_Pokok": 0,
    "Simpanan_Wajib": 0,
    "Simpanan_Sukarela": 0,
    "Total_Simpanan": 0,
    "Total_Pinjaman": 0,
    "SHU_Estimasi": 0,
    "LastUpdated": new Date().toISOString()
  }
};

// =================== DEBUG FUNCTIONS ===================
let debugLog = [];

function logDebug(message, data = null) {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = `[${timestamp}] ${message}`;
  debugLog.push(logEntry);
  
  if (data) {
    console.log(message, data);
    debugLog.push(`  Data: ${JSON.stringify(data).substring(0, 200)}...`);
  } else {
    console.log(message);
  }
  
  updateDebugPanel();
}

function updateDebugPanel() {
  const debugPanel = document.getElementById('debugPanel');
  const debugInfo = document.getElementById('debugInfo');
  
  if (debugPanel && debugInfo) {
    debugInfo.innerHTML = debugLog.slice(-10).join('<br>');
  }
}

function toggleDebug() {
  const debugPanel = document.getElementById('debugPanel');
  debugPanel.style.display = debugPanel.style.display === 'block' ? 'none' : 'block';
}

// =================== HELPER FUNCTIONS ===================
function formatRupiah(angka) {
  if (angka === null || angka === undefined || angka === '') return 'Rp 0';
  const num = Number(angka);
  if (isNaN(num)) return 'Rp 0';
  return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function formatDate(dateString) {
  if (!dateString) return '-';
  
  try {
    // Coba parsing berbagai format tanggal
    let date;
    
    if (dateString.includes('/')) {
      // Format DD/MM/YYYY
      const parts = dateString.split('/');
      date = new Date(parts[2], parts[1] - 1, parts[0]);
    } else if (dateString.includes('-')) {
      // Format YYYY-MM-DD
      date = new Date(dateString);
    } else {
      // Coba parsing langsung
      date = new Date(dateString);
    }
    
    if (isNaN(date.getTime())) {
      return dateString; // Kembalikan as-is jika tidak valid
    }
    
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    
    return `${day}-${month}-${year}`;
  } catch (e) {
    logDebug(`Error formatting date: ${dateString}`, e);
    return dateString;
  }
}

function formatStatus(status) {
  if (!status) return 'AKTIF';
  const statusText = status.toString().toUpperCase();
  return statusText.includes('AKTIF') ? 'AKTIF' : 'TIDAK AKTIF';
}

function getUrlParameter(name) {
  const urlParams = new URLSearchParams(window.location.search);
  const value = urlParams.get(name);
  logDebug(`URL Parameter ${name}: ${value}`);
  return value;
}

// =================== LOAD SPECIFIC MEMBER DATA ===================
async function loadMemberData() {
  logDebug('=== MEMUAT DATA ANGGOTA ===');
  
  try {
    // 1. Ambil ID dari URL parameter
    const memberId = getUrlParameter('id') || 'NIA-001';
    logDebug(`Mencari anggota dengan ID: ${memberId}`);
    
    // 2. Buat URL dengan parameter ID
    const apiUrl = `${CONFIG.APPS_SCRIPT_URL}?id=${encodeURIComponent(memberId)}`;
    logDebug(`API URL: ${apiUrl}`);
    
    // 3. Ambil data dari Google Sheets dengan timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 detik timeout
    
    logDebug('Mengirim request ke Apps Script...');
    
    const response = await fetch(apiUrl, {
      method: 'GET',
      mode: 'cors',
      signal: controller.signal,
      headers: {
        'Accept': 'application/json',
        'Cache-Control': 'no-cache'
      }
    });
    
    clearTimeout(timeoutId);
    
    logDebug(`Response status: ${response.status} ${response.statusText}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
    }
    
    const result = await response.json();
    logDebug('Response dari Apps Script:', result);
    
    let memberData = null;
    
    // 4. Proses data response
    if (result.status === 'success' && result.data && result.data.length > 0) {
      logDebug(`Data ditemukan: ${result.data.length} anggota`);
      
      // Ambil anggota pertama (karena kita cari by ID, harusnya hanya 1)
      memberData = result.data[0];
      logDebug(`Anggota ditemukan: ${memberData['Nama_Lengkap'] || 'Nama tidak tersedia'}`);
      
    } else {
      // Data tidak ditemukan
      logDebug(`Data tidak ditemukan untuk ID: ${memberId}`, result);
      logDebug('Menggunakan data demo...');
      
      // Gunakan data demo dengan ID yang diminta
      memberData = { ...CONFIG.DEMO_MEMBER };
      memberData["ID/NIA"] = memberId;
      memberData["Nama_Lengkap"] = `ID ${memberId} Tidak Ditemukan`;
    }
    
    // 5. Tampilkan kartu
    displayMemberCard(memberData, memberId);
    
  } catch (error) {
    logDebug('ERROR mengambil data:', error);
    
    // Fallback ke data demo
    const memberId = getUrlParameter('id') || 'NIA-001';
    logDebug(`Menggunakan fallback data untuk ID: ${memberId}`);
    
    const fallbackData = { ...CONFIG.DEMO_MEMBER };
    fallbackData["ID/NIA"] = memberId;
    fallbackData["Nama_Lengkap"] = `Error: ${error.message.substring(0, 50)}...`;
    
    displayMemberCard(fallbackData, memberId);
    
    // Tampilkan error ke user
    setTimeout(() => {
      alert(`Error: ${error.message}\n\nCek console untuk detail.`);
    }, 500);
  }
}

// =================== DISPLAY SINGLE CARD ===================
function displayMemberCard(member, memberId) {
  logDebug('Menampilkan kartu untuk:', member['Nama_Lengkap']);
  
  // Proses data - gunakan mapping yang benar
  const memberData = {
    id: member[CONFIG.COLUMN_MAPPING.id] || memberId || '-',
    nama: member[CONFIG.COLUMN_MAPPING.nama] || 'Nama tidak tersedia',
    email: member[CONFIG.COLUMN_MAPPING.email] || '-',
    status: formatStatus(member[CONFIG.COLUMN_MAPPING.status]),
    posisi: member[CONFIG.COLUMN_MAPPING.posisi] || '-',
    alamat: member[CONFIG.COLUMN_MAPPING.alamat] || '-',
    whatsapp: member[CONFIG.COLUMN_MAPPING.whatsapp] || '-',
    jenisKelamin: member[CONFIG.COLUMN_MAPPING.jenisKelamin] || '-',
    agama: member[CONFIG.COLUMN_MAPPING.agama] || '-',
    nik: member[CONFIG.COLUMN_MAPPING.nik] || '-',
    tanggalBergabung: formatDate(member[CONFIG.COLUMN_MAPPING.tanggalBergabung]),
    simpananPokok: Number(member[CONFIG.COLUMN_MAPPING.simpananPokok]) || 0,
    simpananWajib: Number(member[CONFIG.COLUMN_MAPPING.simpananWajib]) || 0,
    simpananSukarela: Number(member[CONFIG.COLUMN_MAPPING.simpananSukarela]) || 0,
    totalSimpanan: Number(member[CONFIG.COLUMN_MAPPING.totalSimpanan]) || 0,
    totalPinjaman: Number(member[CONFIG.COLUMN_MAPPING.totalPinjaman]) || 0,
    shuEstimasi: Number(member[CONFIG.COLUMN_MAPPING.shuEstimasi]) || 0,
    foto: member[CONFIG.COLUMN_MAPPING.foto] || CONFIG.DEMO_MEMBER.Foto
  };
  
  // Hitung total simpanan jika kosong atau 0
  if (memberData.totalSimpanan === 0) {
    memberData.totalSimpanan = memberData.simpananPokok + memberData.simpananWajib + memberData.simpananSukarela;
    logDebug(`Total simpanan dihitung: ${memberData.totalSimpanan}`);
  }
  
  // Status class
  const statusClass = memberData.status === 'AKTIF' ? '' : 'status-inactive';
  
  // Default foto jika kosong
  const fotoUrl = memberData.foto && memberData.foto.trim() !== '' 
    ? memberData.foto 
    : CONFIG.DEMO_MEMBER.Foto;
  
  // Generate kartu HTML
  const cardHTML = `
    <div class="header">
      <div class="logo-wrap">
        <img src="${fotoUrl}" alt="Foto ${memberData.nama}" 
             onerror="this.onerror=null; this.src='${CONFIG.DEMO_MEMBER.Foto}'">
      </div>
      <h1>KOPERASI ASMARA TANI</h1>
      <small>Kartu Anggota Digital</small>
    </div>

    <div class="status">
      <span class="${statusClass}">${memberData.status}</span>
    </div>

    <div class="identity">
      <h2>${memberData.nama}</h2>
      <p>ID: ${memberData.id} | ${memberData.posisi}</p>
    </div>

    <div class="stats">
      <div class="stat"><small>Simpanan Pokok</small><b>${formatRupiah(memberData.simpananPokok)}</b></div>
      <div class="stat"><small>Simpanan Wajib</small><b>${formatRupiah(memberData.simpananWajib)}</b></div>
      <div class="stat"><small>Simpanan Sukarela</small><b>${formatRupiah(memberData.simpananSukarela)}</b></div>
    </div>

    <div class="data">
      <div><span>Alamat</span><b>${memberData.alamat}</b></div>
      <div><span>Jenis Kelamin</span><b>${memberData.jenisKelamin}</b></div>
      <div><span>Agama</span><b>${memberData.agama}</b></div>
      <div><span>NIK</span><b>${memberData.nik}</b></div>
      <div><span>Email</span><b>${memberData.email}</b></div>
      <div><span>WhatsApp</span><b>${memberData.whatsapp}</b></div>
      <div><span>Tanggal Daftar</span><b>${memberData.tanggalBergabung}</b></div>
      <div><span>Total Simpanan</span><b>${formatRupiah(memberData.totalSimpanan)}</b></div>
      <div><span>Total Pinjaman</span><b>${formatRupiah(memberData.totalPinjaman)}</b></div>
      <div><span>Estimasi SHU</span><b>${formatRupiah(memberData.shuEstimasi)}</b></div>
    </div>

    <div class="actions">
      <button onclick="window.print()">üñ®Ô∏è Cetak Kartu</button>
      <button onclick="shareCard()">üì§ Bagikan</button>
      <button onclick="testConnection()">üîß Test API</button>
    </div>

    <div class="qr-section">
      <div class="qr-code" id="qrCode"></div>
      <div class="qr-note">Scan QR Code untuk melihat kartu digital ini</div>
    </div>

    <div class="footer">
      Data tersinkronisasi dari Google Sheets<br>
      ¬© Koperasi Asmara Tani 2026
      <div class="last-update">Terakhir update: ${formatDate(member[CONFIG.COLUMN_MAPPING.lastUpdate] || new Date().toISOString())}</div>
    </div>
  `;
  
  // Update container
  document.getElementById('cardContainer').innerHTML = cardHTML;
  logDebug('Kartu HTML berhasil dibuat');
  
  // Generate QR Code
  setTimeout(() => generateQRCode(memberId), 100);
}

// =================== GENERATE QR CODE ===================
function generateQRCode(memberId) {
  try {
    // URL lengkap dengan parameter ID
    const currentUrl = window.location.href;
    const qrUrl = currentUrl.includes('?') 
      ? currentUrl.split('?')[0] + `?id=${encodeURIComponent(memberId)}`
      : currentUrl + `?id=${encodeURIComponent(memberId)}`;
    
    logDebug(`Generating QR Code untuk: ${qrUrl}`);
    
    // Generate QR Code
    const qr = new QRious({
      element: document.getElementById('qrCode'),
      value: qrUrl,
      size: 150,
      level: 'H',
      foreground: '#061b12',
      background: 'transparent'
    });
    
    logDebug('QR Code berhasil dibuat');
  } catch (error) {
    logDebug('Error generating QR Code:', error);
    const qrElement = document.getElementById('qrCode');
    if (qrElement) {
      qrElement.innerHTML = `<p style="color:#ffa000; padding:20px;">QR Error: ${error.message}</p>`;
    }
  }
}

// =================== SHARE FUNCTION ===================
function shareCard() {
  const memberId = getUrlParameter('id') || 'NIA-001';
  const shareUrl = window.location.href;
  const shareText = `Kartu Digital Anggota Koperasi Asmara Tani - ID: ${memberId}`;
  
  logDebug(`Sharing card: ${shareText}`);
  
  if (navigator.share) {
    navigator.share({
      title: 'Kartu Digital Anggota',
      text: shareText,
      url: shareUrl
    }).then(() => {
      logDebug('Share berhasil');
    }).catch(err => {
      logDebug('Share dibatalkan atau error:', err);
    });
  } else {
    // Fallback: copy to clipboard
    navigator.clipboard.writeText(shareUrl).then(() => {
      alert('‚úÖ Link telah disalin ke clipboard!\n\n' + shareUrl);
      logDebug('URL disalin ke clipboard');
    }).catch(err => {
      logDebug('Gagal copy ke clipboard:', err);
      alert('Gagal menyalin link. Silakan copy manual:\n' + shareUrl);
    });
  }
}

// =================== TEST CONNECTION FUNCTION ===================
async function testConnection() {
  logDebug('=== TESTING API CONNECTION ===');
  
  try {
    const testUrl = CONFIG.APPS_SCRIPT_URL;
    logDebug(`Testing URL: ${testUrl}`);
    
    const response = await fetch(testUrl, {
      method: 'GET',
      mode: 'cors',
      headers: { 'Accept': 'application/json' }
    });
    
    const result = await response.json();
    
    alert(`‚úÖ API Connection Test\nStatus: ${result.status}\nMessage: ${result.message}\nTotal Data: ${result.total || 0}\n\nCek console untuk detail.`);
    logDebug('API Test Result:', result);
    
  } catch (error) {
    alert(`‚ùå API Connection Failed\nError: ${error.message}\n\nCek console untuk detail.`);
    logDebug('API Test Error:', error);
  }
}

// =================== AUTO REFRESH ===================
// setInterval(loadMemberData, 60000); // Refresh setiap 60 detik

// =================== INITIAL LOAD ===================
document.addEventListener('DOMContentLoaded', function() {
  logDebug('=== APLIKASI DIMULAI ===');
  logDebug(`URL: ${window.location.href}`);
  logDebug(`User Agent: ${navigator.userAgent.substring(0, 50)}...`);
  
  // Mulai loading data
  setTimeout(loadMemberData, 500);
});

// Global function untuk testing dari console
window.debugApp = {
  reload: loadMemberData,
  testApi: testConnection,
  getConfig: () => CONFIG,
  getLogs: () => debugLog,
  clearLogs: () => { debugLog = []; updateDebugPanel(); }
};
</script>
</body>
</html>
