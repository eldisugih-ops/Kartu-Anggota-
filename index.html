<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Kartu Digital Anggota</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* CSS SAMA */
body{margin:0;background:linear-gradient(180deg,#061b12,#020b07);font-family:'Poppins',sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:16px;color:#fff;}
.card{width:100%;max-width:390px;background:linear-gradient(160deg,#0f3d28,#062015);border-radius:22px;padding:18px;box-shadow:0 0 35px rgba(0,255,160,.35);border:1px solid rgba(0,255,160,.35);animation:fadeIn 0.5s ease-out;}
@keyframes fadeIn{from{opacity:0; transform:translateY(20px);}to{opacity:1; transform:translateY(0);}}
.header{text-align:center;border-bottom:1px dashed rgba(255,255,255,.25);padding-bottom:14px;}
.logo-wrap{width:86px;height:86px;margin:0 auto 10px;border-radius:50%;background:rgba(255,255,255,.12);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;box-shadow:0 0 18px rgba(0,255,160,.6), inset 0 0 12px rgba(255,255,255,.25);transition:.4s ease;animation:float 4s ease-in-out infinite;}
.logo-wrap:hover{transform:scale(1.08);box-shadow:0 0 28px rgba(0,255,160,.9);}
.logo-wrap img{width:58px;height:58px;border-radius:50%;object-fit:cover;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.header h1{font-size:16px;margin:0;font-weight:700;color:#7dffb2;}
.header small{font-size:11px;opacity:.85;}
.status{margin:12px auto;text-align:center;}
.status span{padding:6px 18px;border-radius:20px;background:#00ff9d33;color:#00ff9d;font-size:12px;font-weight:600;}
.status-inactive{background:#ff3d0033 !important;color:#ffa000 !important;}
.identity{text-align:center;margin:14px 0;}
.identity h2{margin:4px 0;font-size:17px;}
.identity p{margin:0;font-size:12px;color:#a9ffd1;}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:16px 0;}
.stat{background:rgba(0,255,160,.15);border-radius:14px;padding:10px;text-align:center;}
.stat small{font-size:10px;opacity:.9;}
.stat b{display:block;margin-top:6px;font-size:13px;}
.data{font-size:12px;}
.data div{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px dashed rgba(255,255,255,.25);}
.data span{color:#b6ffd1;}
.actions{display:flex;gap:12px;margin:18px 0 6px;}
.actions button{flex:1;border:none;padding:10px;border-radius:14px;background:rgba(0,255,160,.2);color:#00ff9d;font-weight:600;backdrop-filter:blur(10px);box-shadow:0 0 14px rgba(0,255,160,.5);transition:.3s;cursor:pointer;font-family:'Poppins',sans-serif;}
.actions button:hover{background:#00ff9d;color:#003a24;transform:translateY(-2px);}
.footer{margin-top:10px;text-align:center;font-size:10px;opacity:.75;}
.loading{text-align:center;padding:30px;}
.spinner{width:40px;height:40px;border:3px solid rgba(0,255,160,.3);border-top:3px solid #00ff9d;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.last-update{font-size:9px;text-align:center;margin-top:5px;opacity:.6;}
.qr-section{text-align:center;margin-top:20px;padding-top:15px;border-top:1px dashed rgba(255,255,255,.2);}
.qr-code{display:inline-block;background:white;padding:10px;border-radius:12px;margin:10px 0;}
.qr-code canvas{display:block;}
.qr-note{font-size:10px;opacity:.7;margin-top:8px;}
.error-state{text-align:center;padding:40px 20px;}
.error-state h3{color:#ffa000;margin-bottom:10px;}
.debug-panel{position:fixed;top:10px;right:10px;background:rgba(0,0,0,0.8);color:#00ff9d;padding:10px;border-radius:5px;font-size:12px;max-width:300px;z-index:1000;display:none;}
.debug-toggle{position:fixed;top:10px;left:10px;background:#00ff9d;color:#003a24;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;z-index:1001;font-weight:bold;}
.url-info{position:fixed;bottom:10px;left:10px;background:rgba(0,255,160,0.1);padding:10px;border-radius:5px;font-size:11px;max-width:400px;}
</style>

<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>

<body>

<button class="debug-toggle" onclick="toggleDebug()">üêõ Debug</button>
<div class="debug-panel" id="debugPanel"><h4>Debug Information</h4><div id="debugInfo"></div></div>
<div class="url-info" id="urlInfo"></div>

<div class="card" id="cardContainer">
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Memuat data anggota...</p>
  </div>
</div>

<script>
// =================== CONFIGURATION ===================
const CONFIG = {
  // URL APPS SCRIPT BARU ANDA - PASTIKAN INI BENAR!
  APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxXZCLxXNvx-8sTzfE3OrJSeZ4lAqRKCMHpWZxQLHnHGW4Kw2_WR3anL7JoI-TYtXTkKA/exec',
  
  // KOLOM MAPPING
  COLUMN_MAPPING: {
    foto: 'Foto',
    id: 'ID/NIA',
    posisi: 'Posisi',
    nama: 'Nama_Lengkap',
    alamat: 'Alamat_Lengkap',
    jenisKelamin: 'Jenis_Kelamin',
    email: 'Email',
    whatsapp: 'WhatsApp',
    nik: 'NIK',
    agama: 'Agama',
    status: 'Status',
    tanggalBergabung: 'Tanggal_Bergabung',
    simpananPokok: 'Simpanan_Pokok',
    simpananWajib: 'Simpanan_Wajib',
    simpananSukarela: 'Simpanan_Sukarela',
    totalSimpanan: 'Total_Simpanan',
    totalPinjaman: 'Total_Pinjaman',
    shuEstimasi: 'SHU_Estimasi',
    lastUpdate: 'LastUpdated'
  }
};

// =================== DEBUG SYSTEM ===================
let debugLog = [];
function logDebug(msg, data) {
  const time = new Date().toLocaleTimeString();
  debugLog.push(`[${time}] ${msg}`);
  console.log(msg, data || '');
  if (data && typeof data === 'object') {
    debugLog.push(`  Data: ${JSON.stringify(data).substring(0, 100)}`);
  }
  updateDebugPanel();
}
function updateDebugPanel() {
  const panel = document.getElementById('debugPanel');
  const info = document.getElementById('debugInfo');
  if (panel && info) {
    info.innerHTML = debugLog.slice(-10).join('<br>');
  }
}
function toggleDebug() {
  const panel = document.getElementById('debugPanel');
  panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

// =================== INITIAL CHECK ===================
document.addEventListener('DOMContentLoaded', function() {
  // Tampilkan URL info
  const urlInfo = document.getElementById('urlInfo');
  const currentUrl = window.location.href;
  const hasIdParam = currentUrl.includes('?id=');
  
  urlInfo.innerHTML = `
    <strong>URL Saat Ini:</strong><br>
    ${currentUrl}<br>
    <strong>Status Parameter:</strong> ${hasIdParam ? '‚úÖ Ada ?id=' : '‚ùå Tidak ada ?id='}<br>
    <strong>Contoh URL Benar:</strong><br>
    ${currentUrl.split('?')[0]}?id=NIA-001
  `;
  
  // Jika tidak ada parameter ID, minta user
  if (!hasIdParam) {
    const memberId = prompt('Masukkan ID Anggota (contoh: NIA-001):', 'NIA-001');
    if (memberId) {
      // Redirect ke URL dengan parameter
      const newUrl = `${window.location.pathname}?id=${encodeURIComponent(memberId)}`;
      window.location.href = newUrl;
      return;
    }
  }
  
  // Mulai load data
  setTimeout(loadMemberData, 500);
});

// =================== LOAD MEMBER DATA ===================
async function loadMemberData() {
  logDebug('=== MULAI LOAD DATA ===');
  
  // Dapatkan ID dari URL
  const urlParams = new URLSearchParams(window.location.search);
  const memberId = urlParams.get('id') || 'NIA-001';
  logDebug(`ID dari URL: ${memberId}`);
  
  // Validasi ID
  if (!memberId || memberId.trim() === '') {
    showError('ID anggota tidak ditemukan di URL. Gunakan: ?id=NIA-001');
    return;
  }
  
  try {
    // 1. Test koneksi ke Apps Script
    logDebug(`Testing Apps Script: ${CONFIG.APPS_SCRIPT_URL}`);
    
    // Gunakan proxy jika perlu (untuk bypass CORS di development)
    const apiUrl = `${CONFIG.APPS_SCRIPT_URL}?id=${encodeURIComponent(memberId)}`;
    logDebug(`API URL: ${apiUrl}`);
    
    // 2. Fetch data dengan timeout
    const controller = new AbortController();
    const timeout = setTimeout(() => {
      controller.abort();
      throw new Error('Timeout: Apps Script tidak merespon dalam 15 detik');
    }, 15000);
    
    const response = await fetch(apiUrl, {
      method: 'GET',
      mode: 'cors',
      signal: controller.signal,
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });
    
    clearTimeout(timeout);
    
    logDebug(`Response Status: ${response.status}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    logDebug('Apps Script Response:', result);
    
    // 3. Process data
    if (result.status === 'success') {
      if (result.data && result.data.length > 0) {
        // Data ditemukan
        const memberData = result.data[0];
        logDebug(`Data ditemukan: ${memberData['Nama_Lengkap'] || 'Nama tidak tersedia'}`);
        displayMemberCard(memberData, memberId);
      } else {
        // Data tidak ditemukan
        logDebug(`Data untuk ID ${memberId} tidak ditemukan di database`);
        showDemoData(memberId, 'Data tidak ditemukan di database');
      }
    } else {
      // Error dari Apps Script
      throw new Error(`Apps Script Error: ${result.message || 'Unknown error'}`);
    }
    
  } catch (error) {
    logDebug('ERROR:', error);
    
    // Fallback strategies
    if (error.name === 'AbortError') {
      showDemoData(memberId, 'Apps Script timeout. Cek deployment.');
    } else if (error.message.includes('Failed to fetch')) {
      showDemoData(memberId, 'Tidak bisa terhubung ke Apps Script. Cek URL dan CORS.');
    } else {
      showDemoData(memberId, error.message);
    }
    
    // Tampilkan error details
    setTimeout(() => {
      alert(`‚ö†Ô∏è Error: ${error.message}\n\nCek console untuk detail debugging.`);
    }, 1000);
  }
}

// =================== DISPLAY MEMBER CARD ===================
function displayMemberCard(member, memberId) {
  logDebug(`Menampilkan kartu untuk: ${member['Nama_Lengkap'] || memberId}`);
  
  // Process data
  const data = {
    id: member[CONFIG.COLUMN_MAPPING.id] || memberId,
    nama: member[CONFIG.COLUMN_MAPPING.nama] || 'Nama tidak tersedia',
    posisi: member[CONFIG.COLUMN_MAPPING.posisi] || '-',
    status: formatStatus(member[CONFIG.COLUMN_MAPPING.status]),
    alamat: member[CONFIG.COLUMN_MAPPING.alamat] || '-',
    jenisKelamin: member[CONFIG.COLUMN_MAPPING.jenisKelamin] || '-',
    agama: member[CONFIG.COLUMN_MAPPING.agama] || '-',
    nik: member[CONFIG.COLUMN_MAPPING.nik] || '-',
    email: member[CONFIG.COLUMN_MAPPING.email] || '-',
    whatsapp: member[CONFIG.COLUMN_MAPPING.whatsapp] || '-',
    tanggalBergabung: formatDate(member[CONFIG.COLUMN_MAPPING.tanggalBergabung]),
    simpananPokok: Number(member[CONFIG.COLUMN_MAPPING.simpananPokok]) || 0,
    simpananWajib: Number(member[CONFIG.COLUMN_MAPPING.simpananWajib]) || 0,
    simpananSukarela: Number(member[CONFIG.COLUMN_MAPPING.simpananSukarela]) || 0,
    totalSimpanan: Number(member[CONFIG.COLUMN_MAPPING.totalSimpanan]) || 0,
    totalPinjaman: Number(member[CONFIG.COLUMN_MAPPING.totalPinjaman]) || 0,
    shuEstimasi: Number(member[CONFIG.COLUMN_MAPPING.shuEstimasi]) || 0,
    foto: member[CONFIG.COLUMN_MAPPING.foto] || getDefaultPhoto()
  };
  
  // Calculate totals
  if (data.totalSimpanan === 0) {
    data.totalSimpanan = data.simpananPokok + data.simpananWajib + data.simpananSukarela;
  }
  
  // Build HTML
  const statusClass = data.status === 'AKTIF' ? '' : 'status-inactive';
  const photoUrl = data.foto && data.foto.trim() !== '' ? data.foto : getDefaultPhoto();
  
  const html = `
    <div class="header">
      <div class="logo-wrap">
        <img src="${photoUrl}" alt="Foto" onerror="this.src='${getDefaultPhoto()}'">
      </div>
      <h1>KOPERASI ASMARA TANI</h1>
      <small>Kartu Anggota Digital</small>
    </div>
    
    <div class="status"><span class="${statusClass}">${data.status}</span></div>
    
    <div class="identity">
      <h2>${data.nama}</h2>
      <p>ID: ${data.id} | ${data.posisi}</p>
    </div>
    
    <div class="stats">
      <div class="stat"><small>Simpanan Pokok</small><b>${formatRupiah(data.simpananPokok)}</b></div>
      <div class="stat"><small>Simpanan Wajib</small><b>${formatRupiah(data.simpananWajib)}</b></div>
      <div class="stat"><small>Simpanan Sukarela</small><b>${formatRupiah(data.simpananSukarela)}</b></div>
    </div>
    
    <div class="data">
      <div><span>Alamat</span><b>${data.alamat}</b></div>
      <div><span>Jenis Kelamin</span><b>${data.jenisKelamin}</b></div>
      <div><span>Agama</span><b>${data.agama}</b></div>
      <div><span>NIK</span><b>${data.nik}</b></div>
      <div><span>Email</span><b>${data.email}</b></div>
      <div><span>WhatsApp</span><b>${data.whatsapp}</b></div>
      <div><span>Tanggal Daftar</span><b>${data.tanggalBergabung}</b></div>
      <div><span>Total Simpanan</span><b>${formatRupiah(data.totalSimpanan)}</b></div>
      <div><span>Total Pinjaman</span><b>${formatRupiah(data.totalPinjaman)}</b></div>
      <div><span>Estimasi SHU</span><b>${formatRupiah(data.shuEstimasi)}</b></div>
    </div>
    
    <div class="actions">
      <button onclick="window.print()">üñ®Ô∏è Cetak</button>
      <button onclick="shareCard()">üì§ Bagikan</button>
      <button onclick="testAPIConnection()">üîó Test API</button>
    </div>
    
    <div class="qr-section">
      <div class="qr-code" id="qrCode"></div>
      <div class="qr-note">Scan QR untuk kartu digital ini</div>
    </div>
    
    <div class="footer">
      Data dari Google Sheets ‚Ä¢ ¬© Koperasi Asmara Tani 2026
      <div class="last-update">Update: ${formatDate(member[CONFIG.COLUMN_MAPPING.lastUpdate] || new Date())}</div>
    </div>
  `;
  
  document.getElementById('cardContainer').innerHTML = html;
  generateQRCode(memberId);
}

// =================== DEMO DATA FALLBACK ===================
function showDemoData(memberId, reason) {
  logDebug(`Menampilkan data demo: ${reason}`);
  
  const demoData = {
    id: memberId,
    nama: `Demo - ${memberId}`,
    posisi: 'Anggota',
    status: 'AKTIF',
    alamat: 'Data belum tersedia',
    jenisKelamin: '-',
    agama: '-',
    nik: '-',
    email: '-',
    whatsapp: '-',
    tanggalBergabung: formatDate(new Date()),
    simpananPokok: 200000,
    simpananWajib: 50000,
    simpananSukarela: 100000,
    totalSimpanan: 350000,
    totalPinjaman: 0,
    shuEstimasi: 50000,
    foto: getDefaultPhoto()
  };
  
  // Gunakan displayMemberCard dengan data demo
  displayMemberCard(demoData, memberId);
  
  // Tampilkan warning
  const cardContainer = document.getElementById('cardContainer');
  const warning = document.createElement('div');
  warning.style.cssText = `
    background: rgba(255, 160, 0, 0.2);
    border: 1px solid #ffa000;
    border-radius: 10px;
    padding: 10px;
    margin-top: 10px;
    font-size: 12px;
    color: #ffa000;
  `;
  warning.innerHTML = `
    <strong>‚ö†Ô∏è Data Demo Ditampilkan</strong><br>
    Reason: ${reason}<br>
    Pastikan:<br>
    1. URL Apps Script benar<br>
    2. Deployment "Who has access" = "Anyone"<br>
    3. Spreadsheet berisi data ID: ${memberId}
  `;
  
  cardContainer.appendChild(warning);
}

// =================== HELPER FUNCTIONS ===================
function formatRupiah(angka) {
  const num = Number(angka);
  return isNaN(num) ? 'Rp 0' : 'Rp ' + num.toLocaleString('id-ID');
}

function formatDate(dateString) {
  if (!dateString) return '-';
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    return date.toLocaleDateString('id-ID', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  } catch {
    return dateString;
  }
}

function formatStatus(status) {
  if (!status) return 'AKTIF';
  return status.toString().toUpperCase().includes('AKTIF') ? 'AKTIF' : 'TIDAK AKTIF';
}

function getDefaultPhoto() {
  return 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhADAiDm28b0fescUKnqADc9uk3Q2oIptWD-hyzBQXb2AMtoPrxb7Q9Ecr9SDV_RhqA9uWO6qTcepfbfuR7KFWuKUmYYPB-6JfiExBCzT-MljhNh1P1TPsabKvh2rAQzEtZUA0lpiIkIuBxHvHVuXl0GdUWEyaABcfpsHnX_kyDLN_pS2gVNzp_kIP6Vss/s1280/1000007204.jpg';
}

function generateQRCode(memberId) {
  try {
    const currentUrl = window.location.href.split('?')[0];
    const qrUrl = `${currentUrl}?id=${encodeURIComponent(memberId)}`;
    
    new QRious({
      element: document.getElementById('qrCode'),
      value: qrUrl,
      size: 150,
      level: 'H'
    });
    
    logDebug(`QR Code dibuat: ${qrUrl}`);
  } catch (error) {
    document.getElementById('qrCode').innerHTML = 
      `<div style="color:#ffa000; padding:20px;">QR Error</div>`;
  }
}

function shareCard() {
  const memberId = new URLSearchParams(window.location.search).get('id') || 'NIA-001';
  const url = window.location.href;
  
  if (navigator.share) {
    navigator.share({
      title: `Kartu Anggota ${memberId}`,
      text: 'Kartu Digital Anggota Koperasi Asmara Tani',
      url: url
    });
  } else {
    navigator.clipboard.writeText(url).then(() => {
      alert('‚úÖ URL disalin ke clipboard!\n' + url);
    });
  }
}

function testAPIConnection() {
  const testUrl = CONFIG.APPS_SCRIPT_URL;
  logDebug(`Testing: ${testUrl}`);
  
  fetch(testUrl)
    .then(r => r.json())
    .then(data => {
      alert(`‚úÖ API Connected!\nStatus: ${data.status}\nMessage: ${data.message}\nTotal Data: ${data.total || 0}`);
      logDebug('API Test Success:', data);
    })
    .catch(err => {
      alert(`‚ùå API Failed!\nError: ${err.message}`);
      logDebug('API Test Failed:', err);
    });
}

function showError(message) {
  const html = `
    <div class="error-state">
      <h3>‚ùå Error</h3>
      <p>${message}</p>
      <p><strong>Contoh URL yang benar:</strong></p>
      <p style="font-size:11px; background:#000; padding:10px; border-radius:5px;">
        ${window.location.origin}${window.location.pathname}?id=NIA-001
      </p>
      <button onclick="location.href='?id=NIA-001'" style="margin-top:15px; padding:10px; background:#00ff9d; color:#003a24; border:none; border-radius:10px; cursor:pointer;">
        Coba dengan ID: NIA-001
      </button>
    </div>
  `;
  document.getElementById('cardContainer').innerHTML = html;
}

// Global functions for testing
window.debug = {
  reload: () => location.reload(),
  test: testAPIConnection,
  getLogs: () => debugLog,
  getConfig: () => CONFIG
};
</script>
</body>
</html>
